# Read one or several MID files, parse and return the events
read.events.from.con <- 
  function(con, filter = NA, converter = NA, merger = NA, init.value = NA, nevents = -1, time.units = "nus", voltage.units = "mV") {
    state <- 0  # idle
    my.ecount <- 0
    if (is.na(init.value) || is.na(merger)) {
      my.result <- list()
    } else {
      my.result <- init.value
    }
    
    while (length(line <- readLines(con, n=1)) > 0) {
      if (state == 0) {
        if (line == "#EventInfo") {
          state <- 1  # readig event info
          eventInfo <- list()
        } else if (line == "#Waveforms") {
          waveforms <- read.csv(con, header = T, sep = "\t", nrows = eventInfo$WaveformLength)
        } else if (line == "#DcOffsets") {
          dcOffsets <- read.csv(con, header = T, sep = "\t", nrows = 2)
        } else if (line == "#Triggers") {
          triggers <- read.csv(con, header = T, sep = "\t", nrows = 4)
        } else if (line == "#EndOfEvent") {
          my.event <- list(
            eventInfo = eventInfo,
            waveforms = waveforms,
            timeseries = waveforms.to.timeseries(
              eventInfo, waveforms, dcOffsets, time.units = time.units, voltage.units = voltage.units
            ),
            dcOffsets = dcOffsets,
            triggers = triggers
          )
          
          if (is.na(filter) || filter(my.event) == TRUE) {
            my.ecount <- my.ecount + 1
            
            if (!is.na(converter)) {
              my.event <- converter(my.event)
            }
            
            if (is.na(merger)) {
              my.result[[my.ecount]] <- my.event
            } else {
              my.result <- merger(my.result, my.event)
            }
            
            if (nevents >= 0 && nevents <= my.ecount) {
              break
            }
          }
        }
      } else if (state == 1) {
        if (line == "") {
          state <- 0
        } else {
          s <- strsplit(line, "\\s")[[1]]
          name <- s[1]
          if (name == "Device") {
            value <- s[2]
          } else {
            value <- as.numeric(s[2])
          }
          eventInfo[[name]] <- value
        }
      }
    }    
    
    return(my.result)
  }

