\section{Общие сведения}

В состав \GD{} входят программы, написанные на языке~R \cite{RLang} (далее~--- R-скрипты), предназначенные для обработки результатов измерений. Программы представляют собой консольные приложения, управляемые при помощи параметров командной строки.

Скрипты могут использоваться везде, где установлен интерпретатор языка R и необходимые библиотеки (\TERM{пакеты}, \TERM{packages} в терминах R), например непосредственно в ЦОД.

\subsection{Настройка окружения}

Для правильной работы скриптов (включая работу в ЦОД) требуется установить следующие переменные окружения:

\begin{itemize}

\item \ENVVAR{RSCRIPT}~--- путь к программе \COMMAND{Rscript}, интерпретатору языка~R.

\item \ENVVAR{R\_SCRIPT\_DIR}~--- путь к каталогу, в котором хранятся скрипты на языке R.

\item \ENVVAR{SLURM\_SCRIPT\_DIR}~--- путь к каталогу, в котором хранятся скрипты для \COMMAND{sbatch}.

\end{itemize}

Установку переменных рекомендуется разместить в файле \FILE{\~{}/.bashrc}. Для этого поместите в него следующие строки (названия директорий и файлов условные):

\begin{lstlisting}
export RSCRIPT=/home/username/opt/R/bin/Rscript
export R_SCRIPT_DIR=/home/username/lib/r/scripts
export SLURM_SCRIPT_DIR=/home/username/lib/slurm/scripts
\end{lstlisting}

После изменения файла необходимо завершить текущий сеанс работы и начать новый.

Также необходимо установить все требуемые пакеты языка R включая пакет \RPACKAGE{gneis.daq}.

\subsection{Использование ЦОД для выполнения долго работающих скриптов}

Если выполнение R-скрипта требует значительного времени, то рекомендуется запускать его как задание для ЦОД. Такие задания выполняются в фоновом режиме, и пользователь имеет возможность запускать сразу множество заданий, которые будут выполняться параллельно. В этом случае вместе с программой на языке R используется небольшой \COMMAND{bash}-скрипт, имеющий расширение \FILE{.sbatch}. Этот скрипт используется командой \COMMAND{sbatch} \cite{SlurmSbatch}.

\section{Программа {\tt calc-peaks-dist-1d.R} для построения одномерных спектров по данным импульсов}

Данный R-скрипт считывает ранее полученные файлы с вычлененными импульсами (см. приложение~\ref{sec_peaks_file_format}) и формирует текстовый файл с одномерным распределением (далее~--- спектром) нужной величины, например амплитуды импульсов по какому-нибудь каналу.

Для запуска программы используется следующая команда:

\bigskip

\noindent \COMMAND{\$RSCRIPT \$R\_SCRIPT\_DIR/calc-peaks-dist-1d.R {\it <параметры>} {\it <каталог с файлами импульсов>} {\it <имя результирующего файла>}
}

\bigskip
\noindent где {\it <параметры>}~--- параметры программы построения спектра (см. раздел~\ref{sec-peaks-distr-1d-params}), {\it <каталог с файлами импульсов>}~--- путь к каталогу, где расположены ранее сформированные файлы с вычлененными импульсами, {\it <имя результирующего файла>}~--- имя файла, в который будет записан результирующий спектр.

Для запуска программы в качестве задания для ЦОД используется следующая команда:

\bigskip

\noindent \COMMAND{sbatch \$SLURM\_SCRIPT\_DIR/calc-peaks-dist-1d.sbatch {\it <параметры>} {\it <каталог с файлами импульсов>} {\it <имя результирующего файла>}
}

\subsection{Параметры программы}
\label{sec-peaks-distr-1d-params}

\begin{itemize}

\item \CMDARG{-c {\it столбец}}~--- имя столбца данных, по которому строится спектр. Например, если требуется построить амплитудный спектр по каналу №~1, то должно быть указано значение \CMDARG{CH1\_PA}. Полный список столбцов приведён в приложении~\ref{sec_peaks_file_format}.

\item \CMDARG{-{}-min={\it значение}}~--- начальное значение диапазона спектра. Все значения меньшие данного не будут участвовать в статистике. Если параметр не указан, используется значение \CMDARG{0}.

\item \CMDARG{-{}-max={\it значение}}~--- конечное значение диапазона спектра. Все значения большие или равные данному не будут участвовать в статистике. Если параметр не указан, используется значение \CMDARG{1000}.

\item \CMDARG{-{}-step={\it значение}}~--- значения шага спектра. Если параметр не указан, используется значение \CMDARG{1}.

\item \CMDARG{-a}~--- если параметр указан, то искомая величина перед построением спектра будет взята по модулю. Это удобно для тех величин, которые полностью располагаются в отрицательной обласи значений.

\item \CMDARG{-f {\it выражение}}~--- выражение для фильтрации событий. Если параметр указан, в статистику войдут только события, удовлетворяющие данному выражению. Способы построения выражений для фильтрации приведены ниже в разделе~\ref{sec-peaks-distr-1d-filter}.

\item \CMDARG{-n {\it значение}}~--- минимальное количесво событий, которое должно быть включено в статистику. При достижении нужного количества работа программы останавливается. Фактическое количество событий может превышать указанное. Параметр может использоватья для ограничения времени работы скрипта, когда не требуется формировать спектр по всем результатам измерения, а только по малой их части. Если параметр не указан, скрипт обрабатывает все доступные результаты.

\item \CMDARG{-v}~--- если параметр указан, то скрипт в процессе работы выводит в консоль диагностические сообщения о ходе вычислений. Этот режим удобен, когда скрипт запускается непосредственно, а не в качестве задания для ЦОД. В этом случае пользователь имеет возможность оценить текущий прогресс в обработке данных.

\item \CMDARG{-h}~--- если параметр указан, то скрипт выводит в консоль справку о доступных командах и завершает работу.

\end{itemize}

\subsection{Формат результирующего файла}

Скрипт формирует спектр в виде текстового файла из двух колонок, разделяемых символом табуляции. В первой колонке помещены значения диапазона спектра (определённые параметрами \CMDARG{-{}-min} и \CMDARG{-{}-max}), во второй колонке~--- количество событий в данном участке диапазона.

В первой строке файла приведены названия столбцов в кавычках.

Ниже приведён фрагмент файла с временным спектром по каналу №~1 в диапазоне от 0 до 10000 с шагом 10:

\begin{lstlisting}
"CH1_PP_M0"	"COUNT"
10	232331
20	4454
30	232
...
\end{lstlisting}

\subsection{Выражения для фильтрации}
\label{sec-peaks-distr-1d-filter}

Как правило, требуется строить спектры по специально отобранным событиям, для чего программа имеет параметр \CMDARG{-f}. Значение этого параметра представляет собой выражение на языке R, состоящее из столбцов данных, явных числовых значений, арифметических и логических операторов.

Например, пусть требуется включить в статистику только события, сформированные по триггеру №~5. Выражение будет иметь следующий вид:

\begin{lstlisting}
@TRG == 5
\end{lstlisting}

Выражение состоит из 3 частей:

\begin{enumerate}
\item названия столбца данных (\CMDARG{TRG}), предваряемого специальным символом \CMDARG{@};
\item оператора сравнения <<равно>>, имеющего в языке R вид \CMDARG{==};
\item явного числового значения \CMDARG{5}.
\end{enumerate}

Между собой части, для большей читаемости, разделены необязательными пробелами.

Таким образом, в результирующую статистику войдут только те строки исходных файлов, у которых значение колонки \CMDARG{TRG} будет точно равно \CMDARG{5}.

\bigskip

Теперь составим выражение для отбора событий, где абсолютное значение амплитуды по каналу №~3 превышает величину 1000:

\begin{lstlisting}
abs(@CH3_PA) > 1000
\end{lstlisting}

Выражение состоит из 3 частей:

\begin{enumerate}
\item названия столбца данных \CMDARG{CH3\_PA}, предваряемого специальным символом \CMDARG{@}, над которым выполняется функция \CMDARG{abs}, возвращающая абсолютное значение числа;
\item оператора сравнения <<больше>>, имеющего в языке R вид \CMDARG{>};
\item явного числового значения \CMDARG{1000}.
\end{enumerate}

Вместо функции \CMDARG{abs} могут импользоваться любые другие функции языка~R, такие как \CMDARG{exp}, \CMDARG{log} и т.~д.

\bigskip

Теперь объединим оба вышеприведённых критерия фильтрации в одном выражении:

\begin{lstlisting}
@TRG == 5 & abs(@CH3_PA) > 1000
\end{lstlisting}

Обратите внимание на символ \CMDARG{\&}~--- это логический оператор <<и>>. В данном случае он означает, что событие будет участвовать в статистике, если оно удовлетворяет обоим критериям.

Вместо оператора <<и>> можно использовать логический оператор <<или>>, имеющий вид \CMDARG{|}:

\begin{lstlisting}
@TRG == 5 | abs(@CH3_PA) > 1000
\end{lstlisting}

В этом случае событие будет участвовать в статистике, если оно удовлетворяет {\it хотя бы} одному критерию.

\bigskip

Возможно использование арифметических операций, например:

\begin{lstlisting}
abs(@CH3_PA) + abs(@CH4_PA) > 1000
\end{lstlisting}

В данном случае событие будет участвовать в статистике, если сумма абсолютных амплитуд по каналам №~3 и №~4 превышает значение 1000.

\bigskip

Арифметические и логические операции имеют обычный приоритет. Для изменения приоритета операций используются скобки. Например:

\begin{lstlisting}
2 * ( abs(@CH3_PA) + abs(@CH4_PA) ) > 1000
\end{lstlisting}

В данном случае событие будет участвовать в статистике, если удвоенная сумма абсолютных амплитуд по каналам №~3 и №~4 превышает значение 1000.

За ииформацией о приоритете операций в языке R обратитесь к документации по языку.

\bigskip

Таким образом, комбинацией арифметических и логических операторов можно создавать сложные критерии фильтрации.

\subsubsection{Арифметические операции}

В выражениях можно использовать следующие арифметические операции:

\begin{itemize}
\item \CMDARG{+} --- сложение;
\item \CMDARG{-} --- вычитание;
\item \CMDARG{*} --- умножение;
\item \CMDARG{/} --- деление.
\end{itemize}

\subsubsection{Операции сравнения}

В выражениях можно использовать следующие операции сравнения:

\begin{itemize}
\item \CMDARG{==} --- равно;
\item \CMDARG{!=} --- не равно;
\item \CMDARG{>} --- больше;
\item \CMDARG{>=} --- больше или равно;
\item \CMDARG{<} --- меньше;
\item \CMDARG{<=} --- меньше или равно.
\end{itemize}

\subsubsection{Логические операции}

В выражениях можно использовать следующие логические операции:

\begin{itemize}
\item \CMDARG{\&} --- логическое <<и>>;
\item \CMDARG{|} --- логическое <<или>>;
\item \CMDARG{!} --- инверсия;
\item \CMDARG{xor(x, y)} --- логическое <<исключающее или>>.
\end{itemize}

\subsection{Примеры использования}

Пример 1: построить временной спектр по каналу №~1 относительно триггеров по каналу №~0 без фильтрации. 

Файлы с вычлененными импульсами располагаются в каталоге:

 \DIRECTORY{/home/user/exp/session/int}. 

Результирующее распределение будет записано в файл:

 \FILE{/home/user/exp/session/dist.txt}.

\begin{lstlisting}
sbatch $SLURM_SCRIPT_DIR/calc-peaks-dist-1d.sbatch \
  -c CH1_PP_M0 --min=0 --max=10000 --step=10 \
  /home/user/exp/session/int /home/user/exp/session/dist.txt
\end{lstlisting}

\bigskip
Пример 2: построить временной спектр по каналу №~1 относительно триггеров по каналу №~0. В статистику должны попадать только события по триггерному каналу №~5.

\NOTE{} выражение для фильтрации указывается в кавычках.

\begin{lstlisting}
sbatch $SLURM_SCRIPT_DIR/calc-peaks-dist-1d.sbatch \
  -c CH1_PP_M0 --min=0 --max=10000 --step=10 \
  -f "@TRG == 5" \
  /home/user/exp/session/int /home/user/exp/session/dist.txt
\end{lstlisting}

\bigskip
Пример 3: построить временной спектр по каналу №~1 относительно триггеров по каналу №~0. В статистику должны попадать только события по триггерному каналу №~5, где амплитуда импульса на каналу №~1 превышает (по абсолютному значению) значение 1000.

Обратите внимание на использование функции \FILE{abs}, которая возвращает абсолютное значение числа. В данном случае это необходимо, поскольку импульсы по каналу №~1 имеют отрицательную полярность, и их амплитуды имеют отрицательные значения.

\begin{lstlisting}
sbatch $SLURM_SCRIPT_DIR/calc-peaks-dist-1d.sbatch \
  -c CH1_PP_M0 --min=0 --max=10000 --step=10 \
  -f "@TRG == 5 & abs(@CH1_PA) > 1000" \
  /home/user/exp/session/int /home/user/exp/session/dist.txt
\end{lstlisting}

\bigskip
Пример 4: построить амплитудный спектр по каналу №~1. Поскольку импульсы имеют отрицательную полярность, используем параметр \CMDARG{-a} для взятия значений по модулю.

\begin{lstlisting}
sbatch $SLURM_SCRIPT_DIR/calc-peaks-dist-1d.sbatch \
  -c CH1_PA -a --min=0 --max=2000 --step=10 \
  /home/user/exp/session/int /home/user/exp/session/dist.txt
\end{lstlisting}

\section{Программа {\tt calc-peaks-dist-2d.R} для построения двумерных спектров по данным импульсов}

Данный R-скрипт считывает ранее полученные файлы с вычлененными импульсами (см. приложение~\ref{sec_peaks_file_format}) и формирует текстовый файл с матрицей двумерного распределения (далее~--- спектром) нужной величины, например времени и амплитуды импульсов по какому-нибудь каналу.

Для запуска программы используется следующая команда:

\bigskip

\noindent \COMMAND{\$RSCRIPT \$R\_SCRIPT\_DIR/calc-peaks-dist-2d.R {\it <параметры>} {\it <каталог с файлами импульсов>} {\it <имя результирующего файла>}
}

\bigskip
\noindent где {\it <параметры>}~--- параметры программы построения спектра (см. раздел~\ref{sec-peaks-distr-2d-params}), {\it <каталог с файлами импульсов>}~--- путь к каталогу, где расположены ранее сформированные файлы с вычлененными импульсами, {\it <имя результирующего файла>}~--- имя файла, в который будет записан результирующий спектр.

Для запуска программы в качестве задания для ЦОД используется следующая команда:

\bigskip

\noindent \COMMAND{sbatch \$SLURM\_SCRIPT\_DIR/calc-peaks-dist-2d.sbatch {\it <параметры>} {\it <каталог с файлами импульсов>} {\it <имя результирующего файла>}
}

\subsection{Параметры программы}
\label{sec-peaks-distr-2d-params}

\begin{itemize}

\item \CMDARG{-x {\it столбец}}~--- имя столбца данных для горизонтальной оси распределения, что соответствует столбцам матрицы. Например, если требуется построить амплитудный спектр по каналу №~1, то должно быть указано значение \CMDARG{CH1\_PA}. Полный список столбцов приведён в приложении~\ref{sec_peaks_file_format}.

\item \CMDARG{-y {\it столбец}}~--- имя столбца данных для вертикальной оси распределения, что соответствует строкам матрицы. Например, если требуется построить временной спектр по каналу №~1 относительно триггера №~0, то должно быть указано значение \CMDARG{CH1\_PP\_M0}.

\item \CMDARG{-{}-xmin={\it значение}}~--- начальное значение диапазона спектра для горизонтальной оси. Все значения меньшие данного не будут участвовать в статистике. Если параметр не указан, используется значение \CMDARG{0}.

\item \CMDARG{-{}-xmax={\it значение}}~--- конечное значение диапазона спектра для горизонтальной оси. Все значения большие или равные данному не будут участвовать в статистике. Если параметр не указан, используется значение \CMDARG{1000}.

\item \CMDARG{-{}-xstep={\it значение}}~--- значения шага спектра для горизонтальной оси. Если параметр не указан, используется значение \CMDARG{1}.

\item \CMDARG{-{}-ymin={\it значение}}~--- начальное значение диапазона спектра для вертикальной оси. Все значения меньшие данного не будут участвовать в статистике. Если параметр не указан, используется значение \CMDARG{0}.

\item \CMDARG{-{}-ymax={\it значение}}~--- конечное значение диапазона спектра для вертикальной оси. Все значения большие или равные данному не будут участвовать в статистике. Если параметр не указан, используется значение \CMDARG{1000}.

\item \CMDARG{-{}-ystep={\it значение}}~--- значения шага спектра для вертикальной оси. Если параметр не указан, используется значение \CMDARG{1}.

\item \CMDARG{-{}-xabs}~--- если параметр указан, то величина, уканная в параметре \CMDARG{-x}, перед построением спектра будет взята по модулю. Это удобно для тех величин, которые полностью располагаются в отрицательной обласи значений.

\item \CMDARG{-{}-yabs}~--- если параметр указан, то величина, уканная в параметре \CMDARG{-y}, перед построением спектра будет взята по модулю. Это удобно для тех величин, которые полностью располагаются в отрицательной обласи значений.

\item \CMDARG{-f {\it выражение}}~--- выражение для фильтрации событий. Если параметр указан, в статистику войдут только события, удовлетворяющие данному выражению. Способы построения выражений для фильтрации приведены выше в разделе~\ref{sec-peaks-distr-1d-filter}.

\item \CMDARG{-n {\it значение}}~--- минимальное количесво событий, которое должно быть включено в статистику. При достижении нужного количества работа программы останавливается. Фактическое количество событий может превышать указанное. Параметр может использоватья для ограничения времени работы скрипта, когда не требуется формировать спектр по всем результатам измерения, а только по малой их части. Если параметр не указан, скрипт обрабатывает все доступные результаты.

\item \CMDARG{-v}~--- если параметр указан, то скрипт в процессе работы выводит в консоль диагностические сообщения о ходе вычислений. Этот режим удобен, когда скрипт запускается непосредственно, а не в качестве задания для ЦОД. В этом случае пользователь имеет возможность оценить текущий прогресс в обработке данных.

\item \CMDARG{-h}~--- если параметр указан, то скрипт выводит в консоль справку о доступных командах и завершает работу.

\end{itemize}

\subsection{Формат результирующего файла}

Скрипт формирует спектр в виде текстового файла, где каждая строка~--- одна строка матрицы, в которой колонки разделяются символом табуляции.

Ниже приведён фрагмент файла с временно-амплитудным спектром по каналу №~1. В строках меняется значений амплитуды в диапазоне $\left[0, 1000\right)$ с шагом $200$. В столбцах меняется значение временной отметки в диапазоне $\left[0, 1200000\right)$ с шагом $10$. Сами значения~--- количество событий, удовлетворящих соответствующим значений амплитуды и времени. Например, первое число в первой строке --- это количество событий, где амплитуда лежит в диапазоне $\left[0, 200\right)$, а временная отметка --- в диапазоне $\left[0, 10\right)$. Третье число во сторой строке --- это количество событий, где амплитуда лежит в диапазоне $\left[400, 600\right)$, а временная отметка --- в диапазоне $\left[10, 20\right)$ и т.~д.

\begin{lstlisting}
7       0       0       0       0
3       0       0       0       0
8       0       0       0       0
9       3       3       5       0
...
\end{lstlisting}

\subsection{Примеры использования}

Пример 1: построить амплитудно-временной спектр по каналу №~1 относительно триггеров по каналу №~0. По оси X отложен амплитудный диапазон $\left[0, 1000\right)$ с шагом $100$. По оси Y отложен временной диапазон $\left[0, 1200000\right)$ с шагом $100000$. Таким образом, результирующая матрица будет иметь размер $12 \times 10$ (12 строк, 10 столбцов).

Значения амптитуд по каналу №~1 берутся по абсолютному значению (используем параметр \CMDARG{-{}-xabs}).

Также используем фильтрацию: в статистику включены только события, возникшие от триггера по каналу №~5 и только такие, где амплитуда импульса по каналу №~5 превышает по абсолютному значению величину 400.

Файлы с вычлененными импульсами располагаются в каталоге:

 \DIRECTORY{/home/user/exp/session/int}. 

Результирующее распределение будет записано в файл:

 \FILE{/home/user/exp/session/dist.txt}.

Задача запускается как задание в ЦОД, то есть используем скрипт \FILE{calc-peaks-dist-2d.sbatch}.

\begin{lstlisting}
sbatch $SLURM_SCRIPT_DIR/calc-peaks-dist-2d.sbatch \
  -x CH1_PA --xabs -y CH1_PP_M0 \
  --xmin=0 --xmax=1000 --xstep=100 \
  --ymin=0 --ymax=1200000 --ystep=100000 \
  -f "@TRG == 5 & abs(@CH5_PA) > 400" \
  /home/user/exp/session/int /home/user/exp/session/dist.txt
\end{lstlisting}
