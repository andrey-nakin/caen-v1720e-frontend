%\documentclass[12pt, a4paper]{article}
%\usepackage[utf8]{inputenc}
%\usepackage[russian]{babel}
%\usepackage{gensymb}
%\usepackage{graphicx}
%\usepackage{indentfirst}
%\usepackage{url}

%\title{\APP{fe-v1720} --- MIDAS фронтенд-приложение для дигитайзера \DEVICE{}}
%\author{Накин~А.~В.}

%\begin{document}

%\maketitle

\section{Введение}

Приложение \FE{} является фронтендом \cite{MidasWikiFrontend} в системе сбора данных \MIDAS{} (стр.~\pageref{sec-midas-frontend}). Назначение приложения~--- управление дигитайзером \DEVICE{} и чтение wave-форм с него.

\section{Принцип работы}
\label{sec_basic}

\FE{} обеспечивает работу \DEVICE{} в следующем режиме:

\begin{itemize}
\item чтение wave-форм осуществляется с одного или нескольких каналов;
\item длина wave-форм одинакова для всех каналов;
\item запись wave-форм начинается по сигналу триггера одновременно по всем выбранным каналам и заканчивается по достижении нужной длины wave-форм;
\item с момента срабатывания триггера и до окончания записи wave-форм прочие сигналы триггера игнорируются;
\item параметры работы, такие как длина wave-форм, уровень порогового импульса и пр. задаются перед началом работы и хранятся в базе данных ODB \cite{MidasWikiODB}, которая хранит всю информацию об эксперименте в системе \MIDAS{}.
\end{itemize}

\subsection{Формирование триггерного сигнала}
\label{sec-v1720-trigger}

В качестве триггерного сигнала может выступать:

\begin{itemize}

\item Превышение порогового значения импульса по одному или нескольким выделенным каналам, называемым \TERM{триггерными}. В документации CAEN данный режим работы называется \TERM{Self-Trigger}  \cite{CaenUM3051ST}.  Триггерные импульсы могут иметь как положительную, так и отрицательную полярность.

\item Поступление внешнего сигнала на вход <<TRG-IN>> на передней панели \DEVICE{}. В документации CAEN данный режим работы называется \TERM{External Trigger} \cite{CaenUM3051ET}.

\end{itemize}

Возможно использование нескольких источников сигнала одновременно, в этом случае триггер формируется при наступлении любого из событий.

При срабатывании триггера от любого из источников подаётся сигнал на выход <<TRG-OUT>>, что позволяет синхронизировать внешние устройства.

Если используется несколько триггерных каналов, то один из них может быть помечен как \TERM{главный}. Главный триггерный канал используется анализаторами для построения временных гистограмм.

\subsection{Порядок опроса устройства}

Опрос устройства производится следующим образом:

\begin{enumerate}

\item 
\label{item-fe-v1720-poll-check}
\FE{} проверяет, имеются ли в памяти \DEVICE{} события, готовые для чтения.

\item Если событий нет, \FE{} выдерживает паузу, после чего переходит к первому пункту. По умолчанию пауза составляет 10~мс, это значение можно переопределить (см. раздел~\ref{fe-v1720-common-params} на стр.~\pageref{fe-v1720-common-params}).

\item Если в памяти \DEVICE{} имеются готовые события, \FE{} последовательно считывает их до тех пор, пока память не очистится.

\end{enumerate}

\subsection{Поддерживаемые прошивки}

\FE{} работает только с прошивкой <<Waveform Recording>>. Прошивка <<DPP-PSD>> не поддерживается. При попытке работы с дигитайзером, в котором прописана данная прошивка, в систему сообщений \MIDAS{} выдаётся сообщение об ошибке.

\section{Подготовка к работе}

Максимальный размер одного события, приходящего от \DEVICE{}, составляет чуть более 16~Мб, что превышает значение принятое по умолчанию в системе \MIDAS{} и равное 4194304~байтам.

Перед началом работы с \FE{} необходимо скорректировать это значение в следующем разделе базе данных ODB:

\medskip
{\tt /Experiment/MAX\_EVENT\_SIZE}
\medskip

Рекомендуемое значение парамера~--- 20971520 (20~Мб).

\section{Запуск и параметры командной строки}

Приложение \FE{} запускается из командной строки или веб-ин\-тер\-фейса \MIDAS{} \cite{MidasWikiMhttpd} и не имеет собственного графического пользовательского интерфейса. Управление режимами работы осуществляется при помощи параметров командной строки.

Если в эксперименте задействовано одно единственное устройство \DEVICE{}, то приложение \FE{} запускается без параметров. При этом в базе данных ODB в разделе \ODBNODE{Equipment} \cite{MidasWikiEquipment} создаётся запись с названием \ODBNODE{v1720}.

Если в эксперименте задействовано несколько устройств \DEVICE{}, то приложение \FE{} должно быть запущено несколько раз, по числу устройств, с параметром командной строки <<{\tt -i {\it x}}>>, где $x$~--- порядковый номер устройства начиная с нуля. При этом в базе данных ODB создаются записи с названиями \ODBNODE{v172000}, \ODBNODE{v172001} и т.~д.

Полный список поддерживаемых параметров командной строки приведён в \cite{MidasWikiFrontend}. 

\section{Настройка параметров работы в ODB}

Параметры работы \DEVICE{} задаются в следующем разделе базы данных ODB:

\medskip

{\tt /Equipment/v1720{\it xx}}

\medskip

\noindent где $xx$~--- двузначный номер устройства, отсутствующий в случае наличия единственного устройства данного типа.

\subsection{Стандартные параметры}
\label{fe-v1720-common-params}

Стандартные параметры работы \DEVICE{} задаются в следующем разделе базы данных ODB:

\medskip

{\tt /Equipment/v1720{\it xx}/Common}

\medskip

Назначение некоторых параметров:

\begin{itemize}

\item 

\ODBNODE{Period} --- размер паузы между опросами устройства в мс.

\end{itemize}

Полное описание параметров приведено в \cite{MidasWikiEquipment}.

\subsection{Специфичные параметры}
\label{sec-v1720-specific-params}

Специфичные параметры работы \DEVICE{} задаются в следующем разделе базы данных ODB:

\medskip

{\tt /Equipment/v1720{\it xx}/Settings}

\medskip

Назначение параметров:

\begin{itemize}

\item \ODBNODE{link\_num} --- номер интерфейсной карты A2818 или A3818, используемой для связи с \DEVICE{}. Номер начинается с нуля. При использовании единственной карты параметр равен 0.

\item \ODBNODE{conet\_node} --- номер устройства в оптоволоконной сети CONET. Номер начинается с нуля. При наличии единственного устройства в сети CONET параметр равен 0.

\item \ODBNODE{vme\_base\_addr} --- базовый адрес устройства на шине VME, если доступ к \DEVICE{} осуществляется посредством контроллера V1718 или V2718. Если контроллер не используется, данный парамер равен 0.

\item \ODBNODE{waveform\_length} --- длина wave-форм в сэмплах. Допустимые значения: от 0 до 1048576 ($2^{20})$. Рекомендуется использовать значения, являющиеся степенями~2, например 512, 1024 и т.~д. В этом случае внутренняя память \DEVICE{} используется оптимальным образом.

\item \ODBNODE{channel\_enabled} --- каналы, имеющие значение \ODBNODE{y}, участвуют в сборе данных. Для экономии вычислительных и дисковых ресурсов рекомендуется отключать каналы, не имеющие полезного сигнала на входе.

\item \ODBNODE{channel\_dc\_offset} --- сдвиг уровня аналогового сигнала (\TERM{DC Offset}) \cite{CaenUM3051AIS} по каждому из каналов. Диапазон значений: от 0 до 65535. Значение 0 соответствует диапазону $-2 \div 0$~В. Значение 32768 соответствует диапазону $-1 \div 1$~В. Значение 65535 соответствует диапазону $0 \div 2$~В. 

\item \ODBNODE{external\_trigger} --- если указано значение \ODBNODE{y}, то используется внешний триггерный сигнал, подключённый ко входу <<TRG-IN>>.

\item \ODBNODE{trigger\_channel} --- каналы, являющиеся триггерными (стр.~\pageref{sec_basic}).

\item \ODBNODE{trigger\_threshold} --- пороговые уровни триггерных импульсов для каждого из каналов. Допустимые значения: от 0 до 4095.

\item \ODBNODE{trigger\_raising\_polarity} --- типы триггерных импульсов для каждого из каналов. Если указано значение \ODBNODE{y}, триггер реагирует на положительные импульсы, в противном случае --- на отрицательные.

\item \ODBNODE{master\_trigger\_channel} --- номер главного триггерного канала (стр.~\pageref{sec-v1720-trigger}). Если указано отрицательное значение, главных триггерных каналов в данном эксперименте не определено.

\item 
\label{item-pre-trigger-length}

\ODBNODE{pre\_trigger\_length} --- количество сэмплов в wave-формах, предшествующих триггерному сигналу. Допустмые значения: от 0 до значения параметра \ODBNODE{waveform\_length}. В связи с особенностями внутреннего программного обеспечения \DEVICE{} \cite{CaenUM5961PostTrigger} фактическое количество сэмплов будет меньше указанного (на величину порядка 20-30 сэмплов), поэтому данный параметр должен задаваться с соответствующим <<запасом>>.

\item \ODBNODE{front\_panel\_io\_level} --- уровень электрических сигналов, подаваемых и снимаемых с передней панели \DEVICE{}, таких как <<TRG-IN>> или <<TRG-OUT>>. Допустимые значения: \ODBNODE{nim} или \ODBNODE{ttl}. На передней панели \DEVICE{} имеется индикация выбранного уровеня.

\end{itemize}

\section{Формат результирующих данных}
\label{sec_v1720_event}

Приложение \FE{} формирует отдельное событие (стр.~\pageref{sec-midas-event}) при каждом полезном срабывании триггера. Событие включает в себя следующие банки данных:

\begin{itemize}

\item \BANK{V200}~--- общая информация о событии;
\item \BANK{TRIG}~--- параметры триггера;
\item \BANK{CHDC}~--- значения DC offset для каналов дигитайзера на момент формирования события;
\item \BANK{WF00}~..~\BANK{WF07}~--- wave-формы с нулевого по седьмой каналы.

\end{itemize}

\subsection{Банк \BANK{V200}}
\label{sec_bank_info}

Данный банк содержит общую информацию о событии. Формат банка: 32-битные беззнаковые слова. Размер банка: 8 слов. Назначение слов приведено в таблице~\ref{tab-info-bank}.

\begin{table*}[h]
\centering
\begin{tabular}{ll}
\hline\hline
№ слова & Значение \\
\hline

0 & Board ID \\
1 & Битовая маска каналов. \\
2 & Счётчик событий. \\
3 & Trigger time stamp \cite{CaenUM3051TS}. \\
4 & Биты 7--0: \BITVALUE{1} если триггер сработал по каналу, \\
 & соответствующему номеру бита. \\
 & Бит 8: Зарезервировано, равно 0. \\
 & Бит 9: \BITVALUE{1} если триггер сработал от входа <<TRG-IN>>. \\
 & Биты 31--10: Зарезервировано, равно 0. \\
5 & Номер устройства или {\tt 0xFFFFFFFF} \\
6 & Значение параметра \ODBNODE{pre\_trigger\_length} (стр.~\pageref{item-pre-trigger-length}) \\
7 & Зарезервировано, равно 0 \\

\hline\hline
\end{tabular}
\caption{Назначение слов в банке \BANK{V200}.}
\label{tab-info-bank}
\end{table*}

Битовая маска содержит информацию о каналах, участвующих в сборе данных. Если $i$-ый канал включён в сбор данных, то $i$-ый бит в маске установлен в единицу.

Если в системе используется одно единственное устройство \DEVICE{}, то слово №~5 имеет значение {\tt 0xFFFFFFFF}.

Наличие банка \BANK{V200} в событии служит индикатором того, что событие пришло от устройства \DEVICE{}.

\subsection{Банк \BANK{TRIG}}
\label{sec_bank_trig}

Данный банк содержит информацию о параметрах триггерных каналов. Формат банка: 16-битные беззнаковые слова. Размер банка: динамический, по 4 слова для каждого триггерного канала. Назначение слов приведено в таблице~\ref{tab-trig-bank}.

\begin{table*}[h]
\centering
\begin{tabular}{ll}
\hline\hline
№ слова & Значение \\
\hline

0 & Номер триггерного канала. \\
1 & Порог срабатывания триггера. \\
2 & Бит 0: \BITVALUE{1} при положительной полярности триггерного импульса, \\
 & иначе \BITVALUE{0}. \\
 & Бит 1: \BITVALUE{1} если триггерый канал является главным, \\
 & иначе \BITVALUE{0}. \\
 & Биты 15--2: зарезервировано, равно 0. \\
3 & Зарезервировано, равно 0. \\

\hline\hline
\end{tabular}
\caption{Назначение слов в банке \BANK{TRIG}.}
\label{tab-trig-bank}
\end{table*}

Банк не создаётся, если в качестве источника триггера используется только внешний сигнал (стр.~\pageref{sec-v1720-trigger}).

\subsection{Банк \BANK{CHDC}}

Банк содержит значения DC offset \cite{CaenUM3051AIS} по всем 8 каналам дигитайзера, включая каналы, незадействованные в сборе данных.

Формат банка: 16-битные беззнаковые слова. Размер банка: 8 слов. Слово №~0 содержит значение DC offset для канала №~0, слово №~1~--- для канала №~1 и так далее.

\subsection{Банки \BANK{WF0{\it i}}}

Банки данного типа  содержат данные wave-формы по одному из каналов. Название банка имеет вид \BANK{WF0{\it i}}, где $i$~--- номер канала начиная с нуля, например \BANK{WF00}, \BANK{WF01} и так далее.

Формат банка: 16-битные беззнаковые слова. Размер банка: произвольный, соответствует выбранной длине wave-форм. Каждое слово соответствует одному сэмплу wave-формы, при этом задействованы только младшие 12 битов, старшие 4 бита не используются и равны нулю.

Наличие банка в составе события зависит от того, участвует ли данный канал в сборе данных. Если канал $i$ включён, то $i$-ый бит в битовой маске банка \BANK{V200} (стр.~\pageref{sec_bank_info}) установлен в единицу, и банк \BANK{WF0{\it i}} входит в состав события.

%\begin{thebibliography}{99} 

%\bibitem{MidasWikiFrontend}  {\url{https://midas.triumf.ca/MidasWiki/index.php/Frontend_Application}} 

%\bibitem{MidasWiki}  {\url{https://midas.triumf.ca/MidasWiki/index.php/Main_Page}} 

%\bibitem{CaenUM3051ST}  {CAEN User Manual UM3051, раздел <<Self-Trigger>>, стр.~41} 

%\bibitem{MidasWikiODB}  {\url{https://midas.triumf.ca/MidasWiki/index.php/ODB_Access_and_Use}} 

%\bibitem{MidasWikiMhttpd}  {\url{https://midas.triumf.ca/MidasWiki/index.php/Mhttpd}} 

%\bibitem{MidasWikiEquipment}  {\url{https://midas.triumf.ca/MidasWiki/index.php//Equipment_ODB_tree}} 

%\bibitem{CaenUM3051AIS}  {CAEN User Manual UM3051, раздел <<Analog Input Stage>>, стр.~22} 

%\bibitem{CaenUM5961PostTrigger}  {CAEN User Manual UM5961, раздел <<Post Trigger>>, стр.~26} 

%\bibitem{MidasWikiEvent}  {\url{https://midas.triumf.ca/MidasWiki/index.php/Event_Structure}} 

%\bibitem{CaenUM3051TS}  {CAEN User Manual UM3051, раздел <<Technical Specifications>>, стр.~12} 

%\end{thebibliography}

%\end{document}

